<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TinyLink â€” Premium Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50">

  <!-- HEADER -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-purple-700">TinyLink <span class="text-gray-700">Premium</span></h1>
    <span class="text-green-600 font-semibold">Status: online</span>
  </header>

  <!-- MAIN GRID -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">

    <!-- LEFT SIDE: Create Link -->
    <div class="bg-white p-6 rounded-xl shadow space-y-4">
      <h2 class="text-xl font-semibold mb-2">Create Short Link</h2>

      <input id="urlInput" 
        class="border p-3 rounded w-full"
        placeholder="https://example.com/page">

      <input id="codeInput" 
        class="border p-3 rounded w-full"
        placeholder="Custom code (optional)">

      <div class="flex gap-3">
        <button onclick="createLink()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 w-full">
          Create
        </button>

        <button onclick="randomCode()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
          Random
        </button>
      </div>

      <p id="msg" class="text-sm"></p>

      <div class="flex gap-3 mt-3">
        <button onclick="loadLinks()" class="border px-3 py-2 rounded">Refresh</button>
        <button onclick="openStatsPage()" class="border px-3 py-2 rounded">Open Latest Stats</button>
      </div>
    </div>

    <!-- RIGHT SIDE: List + Chart + Preview -->
    <div class="lg:col-span-2 space-y-6">

      <!-- LINKS TABLE -->
      <div class="bg-white p-6 rounded-xl shadow">
        <div class="flex justify-between mb-3">
          <h2 class="text-xl font-semibold">All Short Links</h2>
          <span id="total" class="text-sm text-gray-600"></span>
        </div>

        <table class="w-full text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2">Short</th>
              <th class="p-2">Target</th>
              <th class="p-2">Clicks</th>
              <th class="p-2">Last</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="linksTable"></tbody>
        </table>
      </div>

      <!-- GRAPH + PREVIEW -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- CHART -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h2 class="font-semibold mb-3">Top Links (Clicks)</h2>
          <canvas id="chart"></canvas>
        </div>

        <!-- PREVIEW -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h2 class="font-semibold mb-3">Preview</h2>
          <div id="preview" class="text-gray-500">Select a row to preview short link, QR, and actions.</div>
        </div>

      </div>

    </div>
  </div>

<script>
const API = "";

// =========================
// CREATE RANDOM CODE
// =========================
function randomCode() {
  document.getElementById("codeInput").value = Math.random().toString(36).substring(2, 8);
}

// =========================
// CREATE NEW LINK
// =========================
async function createLink() {
  const url = urlInput.value.trim();
  const code = codeInput.value.trim() || Math.random().toString(36).substring(2, 8);
  const msg = document.getElementById("msg");

  msg.innerHTML = "";
  msg.className = "text-sm";

  if (!url) {
    msg.classList.add("text-red-600");
    msg.innerHTML = "URL required!";
    return;
  }

  const res = await fetch("/api/links", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ url, code })
  });

  if (res.status === 409) {
    msg.classList.add("text-red-600");
    msg.innerHTML = "Code already exists!";
    return;
  }

  msg.classList.add("text-green-600");
  msg.innerHTML = "Short link created!";
  urlInput.value = "";
  codeInput.value = "";

  loadLinks();
}

// =========================
// LOAD LINKS INTO TABLE
// =========================
let chart;

async function loadLinks() {
  const res = await fetch("/api/links");
  const data = await res.json();

  total.innerText = "Total: " + data.length;
  let html = "";

  const labels = [];
  const clicks = [];

  data.forEach(link => {
    labels.push(link.code);
    clicks.push(link.clicks);

    html += `
      <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="showPreview('${link.code}', '${link.url}', ${link.clicks})">
        <td class="p-2 text-purple-700 font-semibold">${link.code}</td>
        <td class="p-2 break-all">${link.url}</td>
        <td class="p-2">${link.clicks}</td>
        <td class="p-2">${link.last_clicked || "-"}</td>
        <td class="p-2 space-x-1">
          <button onclick="copyLink('${link.code}'); event.stopPropagation()" class="bg-black text-white px-2 py-1 rounded">Copy</button>
          <button onclick="shareLink('${link.code}'); event.stopPropagation()" class="bg-green-600 text-white px-2 py-1 rounded">Share</button>
          <button onclick="openStats('${link.code}'); event.stopPropagation()" class="bg-blue-600 text-white px-2 py-1 rounded">Stats</button>
          <button onclick="deleteLink('${link.code}'); event.stopPropagation()" class="bg-red-600 text-white px-2 py-1 rounded">Delete</button>
        </td>
      </tr>`;
  });

  linksTable.innerHTML = html;

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Clicks",
        data: clicks,
        borderWidth: 2,
        borderColor: "#6b46c1",
        tension: 0.3
      }]
    }
  });
}

// =========================
// PREVIEW PANEL
// =========================
function showPreview(code, url, clicks) {
  const shortUrl = `${window.location.origin}/${code}`;

  preview.innerHTML = `
    <p><strong>Short Link:</strong> <a class="text-purple-600 underline" href="${shortUrl}" target="_blank">${shortUrl}</a></p>
    <p><strong>Target:</strong> ${url}</p>
    <p><strong>Clicks:</strong> ${clicks}</p>

    <div class="mt-4 space-y-2">
      <button onclick="copyLink('${code}')" class="bg-black text-white w-full py-2 rounded">Copy</button>
      <button onclick="shareLink('${code}')" class="bg-green-600 text-white w-full py-2 rounded">Share</button>
      <button onclick="openStats('${code}')" class="bg-blue-600 text-white w-full py-2 rounded">Stats</button>
    </div>
  `;
}

// =========================
// BUTTON ACTIONS
// =========================
function copyLink(code) {
  navigator.clipboard.writeText(window.location.origin + "/" + code);
  alert("Copied!");
}

function shareLink(code) {
  navigator.share({ title: "TinyLink", url: window.location.origin + "/" + code });
}

function openStats(code) {
  window.location.href = "/code/" + code;
}

async function deleteLink(code) {
  await fetch("/api/links/" + code, { method: "DELETE" });
  loadLinks();
}

function openStatsPage() {
  window.location.href = "/code/" + latestCode;
}

// LOAD ON START
loadLinks();
</script>

</body>
</html>
